# 灰度发布

## 用途
灰度发布系统的作用在于，可以根据自己的配置，来将用户的流量导到新上线的系统上，来快速验证新的功能修改，而一旦出问题，也可以马上的恢复，简单的说，就是一套A/BTest系统。

## 架构
![灰度架构]

主要分为几个部分:
  * 接入层，接入客户端请求，根据下发的配置将符合条件的请求转发到新旧系统上
  * 配置管理后台，这个后台可以配置不同的转发策略给接入层
  * 新旧两种处理客户端请求的业务服务器

## 策略接入感知
 * 如果管理后台下发了新的转发策略，接入层应该是可以马上感知到然后切换到这个新的策略来的
 * 如果接入层是Nginx,可能还需要在每台接入服务器上部署一个Agent的服务，主要用于:
   * 接收管理后台下发的策略，更新Nginx配置，然后优雅重启Nginx服务．
   * 定时检查本台机器的Nginx服务的状态，进行上报．
 * 如果接入层是Java服务，可以采用pub-sub模型，用ZK，Redis，配置中心都可以，订阅管理后台下发的服务进行处理即可

## 业务场景
#### 调用链上有多个业务服务的场景
考虑这样一个业务场景，假设对外提供了服务Ａ给客户端访问，服务Ａ后面会调用服务Ｂ，Ｃ，Ｄ，此时需要上线一个功能，这个功能涉及到了服务Ａ，Ｃ的修改，但是服务Ｂ，Ｄ不需要变动，换言之，我们的意图是，如果一个客户端请求，走到了新的灰度服务Ａ，那么最终这个请求也应该走到这次和Ａ一起灰度的服务Ｃ上．

这里的处理策略，可以给客户端请求进行tag打标记的方式，比如经由新版本服务Ａ处理的请求，全部打上tag A，而在服务Ｃ上，也有接入层进行转发，它转发的策略之一就是根据根据这个tag来进行转发，这个系统如下图所示：

 ![business1]

上图中，请求首先走到了旧版本的服务Ａ上，该服务没有对请求打上tag，所以后续访问的都是没有配套灰度的旧版本Ｃ服务．

![business2]

上图中，请求首先走到了新版本需要灰度的服务Ａ上，在经过该服务处理后，给请求打上了tag　Ａ，由于带上了tag，后续访问的都是配套灰度的Ｃ服务

简单的总结下，涉及到一个调用链路上某几个服务需要灰度的情况，可以通过tag的方式，将走灰度服务的请求汇集到一起来，如果一个请求走到了一个灰度路径上，就打上一个tag，这样只有有这个tag的请求才能走到这条链路上后续也需要一起灰度的服务上．至于如何给请求打tag，如果是http协议，那就很简单了，也是加Header的方式，否则需要在设计协议的时候就考虑协议的扩展性支持这个操作．

[灰度架构]: img/灰度架构.png
[business1]: img/business1.png
[business2]: img/business2.png
