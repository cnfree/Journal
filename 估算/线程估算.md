# 线程估算
关键字： `线程数估算` `队列容量估算`

线程估算包含线程数估算和线程池队列容量大小估算。

## 线程数估算
线程数估算分两种情况：CPU密集型和IO密集型。

* 如果是CPU密集型应用，则线程池大小设置为N+1
* 如果是IO密集型应用：
 ```
    最佳线程数目 = （（线程等待时间+线程CPU时间）/线程CPU时间 ）* CPU数目 * CPU利用率
    
    换算一下，可以得到
    
    最佳线程数目 = （线程等待时间/线程CPU时间 + 1）* CPU数目 * CPU利用率

 ```
* 线程等待时间所占比例越高，需要越多线程。线程CPU时间所占比例越高，需要越少线程。
* 线程等待时间包括数据库连接时间，缓存连接时间，MQ请求时间，RPC调用时间，第三方请求等等。
* 实际情况需要通过压测工具（JMeter）来压测一下线服务器，同时根据qps值来动态微调刚才计算出的线程池大小。
* 线程CPU使用时间可以使用API获得：
    ```
    ManagementFactory.getThreadMXBean().getCurrentThreadCpuTime();
    ```
* 因为任务总时间可知，CPU使用时间可知，所以可以计算出一个理论的最佳线程数目。

## 线程池队列容量大小估算 
* 首先需要限定队列堆空间占用大小，比如1M，然后计算当前内存使用量
    ```
    Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();
    ```
* 创建1000个任务，加入队列，再次计算当前内存使用量
* 根据两次内存使用量之差，可以得出1M堆空间大小可以放置多少队列
    ```
      1000 * 1M / (m2 - m1)
    ```